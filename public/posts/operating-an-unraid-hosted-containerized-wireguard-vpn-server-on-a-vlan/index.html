<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN | wallaceLabs</title><meta name=keywords content="Unraid,Wireguard,subnet,VLAN,Containers">
<meta name=description content="I run my home network on Ubiquiti UniFi based hardware utilizing a UniFi Dream Machine Pro (UDMP) as my gateway/firewall, along with an assortment of UniFi Access Points (APs) and managed switches. In the event that I need to remote into my network, my gateway operates an L2TP over IPsec VPN. Using the built in Radius server, I&rsquo;ve been able to configure this VPN so that remote clients are automatically routed to a specific subnet via a VLAN tag.">
<meta name=author content="Samuel Wallace">
<link rel=canonical href=https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wallacelabs.tech/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://wallacelabs.tech/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://wallacelabs.tech/favicon-32x32.png>
<link rel=apple-touch-icon href=https://wallacelabs.tech/apple-touch-icon.png>
<link rel=mask-icon href=https://wallacelabs.tech/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN">
<meta property="og:description" content="I run my home network on Ubiquiti UniFi based hardware utilizing a UniFi Dream Machine Pro (UDMP) as my gateway/firewall, along with an assortment of UniFi Access Points (APs) and managed switches. In the event that I need to remote into my network, my gateway operates an L2TP over IPsec VPN. Using the built in Radius server, I&rsquo;ve been able to configure this VPN so that remote clients are automatically routed to a specific subnet via a VLAN tag.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/">
<meta property="og:image" content="https://wallacelabs.tech/cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-03-21T20:29:16+00:00">
<meta property="article:modified_time" content="2022-03-21T20:29:16+00:00"><meta property="og:site_name" content="wallaceLabs">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://wallacelabs.tech/cover.png">
<meta name=twitter:title content="Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN">
<meta name=twitter:description content="I run my home network on Ubiquiti UniFi based hardware utilizing a UniFi Dream Machine Pro (UDMP) as my gateway/firewall, along with an assortment of UniFi Access Points (APs) and managed switches. In the event that I need to remote into my network, my gateway operates an L2TP over IPsec VPN. Using the built in Radius server, I&rsquo;ve been able to configure this VPN so that remote clients are automatically routed to a specific subnet via a VLAN tag.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://wallacelabs.tech/posts/"},{"@type":"ListItem","position":3,"name":"Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN","item":"https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN","name":"Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN","description":"I run my home network on Ubiquiti UniFi based hardware utilizing a UniFi Dream Machine Pro (UDMP) as my gateway/firewall, along with an assortment of UniFi Access Points (APs) and managed switches. In the event that I need to remote into my network, my gateway operates an L2TP over IPsec VPN. Using the built in Radius server, I\u0026rsquo;ve been able to configure this VPN so that remote clients are automatically routed to a specific subnet via a VLAN tag.","keywords":["Unraid","Wireguard","subnet","VLAN","Containers"],"articleBody":"I run my home network on Ubiquiti UniFi based hardware utilizing a UniFi Dream Machine Pro (UDMP) as my gateway/firewall, along with an assortment of UniFi Access Points (APs) and managed switches. In the event that I need to remote into my network, my gateway operates an L2TP over IPsec VPN. Using the built in Radius server, I’ve been able to configure this VPN so that remote clients are automatically routed to a specific subnet via a VLAN tag. This has been great, because I can give myself access to my full network, while limiting other clients to isolated sections of my network as desired.\nRecently, however, I began testing Ubiquiti’s UID (UniFi Identity) product as an Early Access member. I won’t spend too much time on this, as the product is very much still in development (and I believe the Early Access terms of service prevent me from doing so anyway), but suffice it to say that utilizing UID has put a temporary crimp in my normal VPN operations. In short, the UID platform, when integrated on my firewall, runs all VPN authentication through its identity management platform (which can integrate with LDAP, Active Directory, etc). This functionality is very cool, but not fully fleshed out yet. My problem is that, for the time being, there is no way to assign a given user a vlan tag. This prevents me from locking certain users to particular subnets where firewall rules prevent them from accessing the network at large.\nUbiquiti has confirmed that this functionality will be coming eventually, but in the meantime I’m stuck, as tagging VPN users to a vlan is something I regularly need to do. It is with all this in mind that I began considering operating a second VPN server directly from an isolated subnet as a temporary work-around.\nImplementation Considerations With an action plan worked out, I fiddled around with a few different approaches. I briefly considered setting up an OpenVPN server, but quickly moved on to Wireguard due to its security, speed, and relative simplicity.\nOperating the server as a Docker container was also a big deal, as I have containerized practically all of my Homelab’s infrastructure at this point. Generally speaking, if I can’t run it as a container, I’ll find another solution. Dedicated application environments are too important, and accomplishing this isolation with Virtual Machines is too resource-expensive for it to be an ongoing solution. Containers or bust!\nLastly, I wanted to run all this using my Unraid Server as a host. For the unfamiliar, Unraid is a Linux based OS focused on enabling Network Attached Storage (NAS) functions and VM/Container hosting. My Unraid server is where I host a good deal of containerized infrastructure for my home– no reason to run this Wireguard server anywhere else.\n Note: The Unraid OS actually has a built-in Wireguard server. Why not just use that? In theory, I could, and I did try. The reason I am not is because my goal in all of this is to have clients connected to this VPN restricted to a given subnet. Unfortunately, any clients connected to Unraid’s built-in Wireguard server end up on the same subnet as the Unraid server itself. In my case, my Unraid server is connected to an untagged network port, and thus is on my primary LAN network, not on a restricted subnet where I want these clients to end up. As of the time of writing, there is no way to assign the built-in Wireguard service to a virtual, vlan-tagged network interface. The good news is that Unraid OS does support assigning vlan-tagged virtual network interfaces to any VM or container it hosts– thus my goal of operating a Wireguard server as a container.\n Making It Happen The first step in getting this server online was to find a Docker Image designed for creating a containerized Wireguard server.\n I initially thought I’d build one by hand, and got most of the way through the process before deciding it wasn’t worth the effort for what will ultimately be a temporary solution anyway. That being said, I learned a lot, and if you’d like to set down that path yourself, I fully recommend following this excellent guide written by Jamon Camisso at Digital Ocean.\n After a bit of research, there were a couple images I was considering. The first was docker-wireguard by the great LinuxServer.io group. Second, and what I’ve ended up going with, is wg-easy. The linuxserver.io wireguard container is more flexible, but wg-easy ended up being easier for my purposes, and offers the great benefit of hosting a cool web-management panel for creating client connections, viewing their QR codes, downloading their configuration files, etc. All things that can be trivially done via CLI, but the GUI web panel makes things a bit easier, and prettier for every-day use.\nGreat, I found an image on DockerHub that does exactly what I need it to. All thats left is to get it running on my Unraid server, right? Unfortunately, thats not where this story ends.\nThe Problem Recall that the whole point of this endeavor was to give VPN clients access to a subnet of my network only, not the whole thing. Furthermore, recall that any clients connected to the Wireguard server will have access to the same network the Wireguard server itself resides on. With that in mind, the only way to restrict Wireguard clients to a given subnet is to operate the Wireguard server on that same subnet.\n Note: This limitation could be avoided if the wireguard server were being run on the gateway/router, but UniFi does not currently support running a Wireguard server, and again there is the complication introduced by UID. All of this is a long way of saying if you have a PFSense gateway (or another gateway that supports operating a wireguard server), you could probably work around this issue. Beyond that, you could probably get it working with a multi-gateway type setup, with a dedicated PFsense box that handles some routing, but is not your primary “router”, per se… but that is entering into a world of networking complexity that goes far beyond the scope of this post. A post for another day, perhaps.\n So, I’ve got a Wireguard server docker container. How do I go about getting it on the correct subnet? The best way to get this container on my subnet of choice is to run the container using host networking mode, instead of bridge. On the host, I created a virtual network interface, tagged it to the relevant vlan, and assigned that interface to my container running in host networking mode. Simple enough, right? Well, it should be. Creating the interface is no big deal on Unraid. Just have to open up the Unraid web-management panel, navigate to Settings--Network Settings, enable VLANS, and configure a virtual interface to be tagged to a vlan, as seen below:\n The same thing should also be simple enough to implement on Windows, on macOS, or generically on Linux. That being said, I have not tested it. This walk-through is assuming the use of Unraid, I just wanted to make it clear that there’s no reason this could not be done on another platform.\nHere is the problem- the wg-easy container does not run correctly when configured to run in host-networking mode. The container starts up correctly, the Wireguard server runs, and clients can even connect- but they cannot seem to pass any data. I’ve been unable to determine a solution, and not for lack of trying. There is an open issue on the container’s Github page, and I’ve asked around on the container’s support page on the Unraid Forums. So far, nothing has proved useful.\nI have not made much headway, but I’m still hoping to find a solution. Though I am reluctant to give up on the convince of the web-management panel, I’ve been considering trying the LinuxServer.io Wireguard container (with host networking) and seeing if that works. If it does, it might prove helpful in determining what is wrong in wg-easy when running host networking. I’ve also considered revisiting building a wireguard server container from scratch, hoping it might give me a better “under the hood” understanding of wireguard such that I can better determine what is breaking in wg-easy when running in host networking.\nUltimately, unless someone else posts a solution on Github, solving this issue is going to involve some degree of reverse engineering the wg-easy container, and and I go back and forth on whether its worth the time investment. This was supposed to be a quick, temporary solution! It has turned into a whole project, like these things often do\nEating My Words In the meantime, to solve my problem day to day, I have been eating my words about only running infrastructure inside containers. I setup a Linux VM on my Unraid server, and installed Docker on that VM for some nested virtualization action. Still using containers! Just nested inside a VM, unfortunately. This solves my problem because I am able to assign the VLAN tagged virtual network interface to the VM. Then, when the container runs with bridge networking inside the VM, any connected Wireguard clients end up on the correct subnet, just as I’ve been hoping to achieve this whole time. Its all a bit more convoluted than I would like, but it works nonetheless.\nIf you would like to implement a similar solution, it should be fairly simple. First, log on to Unraid and navigate to Settings--Network Settings, enable VLANS, and configure a virtual interface to be tagged to a vlan (as discussed earlier).\n Quick Aside: Be aware that you’ll need to make sure the network port your Unraid server is connected to is configured for both your untagged native network, and tagged for your desired vlan. It might even make sense to set it up as a trunk port (carries all vlans) if you intend to use all vlans on your Unraid server for different VM’s, containers, etc. Alternately, if your server has multiple network ports (via a dedicated PCIe NIC, or the like), you could just connect your server to multiple ports and use dedicated physical interfaces. Lots of options here.\n Then, configure a VM of your choice. I initially setup a Windows 11 VM for this, being curious how WSL and Docker Desktop would behave utilizing nested virtualization. Turns out, the answer is not well. The VM maxes out all assigned CPU cores and freezes up after a few minutes idle. Did some cursory troubleshooting, and there appears to be no solution at the moment. With that in mind, I’d recommend a Linux OS. Ubuntu or Debian are usually my go-to for a quick VM, but its really just preference. Just make sure to assign your vlan tagged virtual network interface to that VM.\nWith your VM running, install Docker, and follow the instructions on the wg-easy Github page to get your Wireguard server running. When you’re done, you’ll have a wireguard server running such that all connecting clients are restricted to your desired subnet. Mission accomplished!\nI hope you might find my documented struggles here useful, or entertaining at the very least. If you happen to have a solution to running wg-easy in host networking mode, please let me know! I’d be thrilled. Just hit me up on the Github issue I linked earlier, or on the site’s Discord server. Thanks!\n","wordCount":"1908","inLanguage":"en","image":"https://wallacelabs.tech/cover.png","datePublished":"2022-03-21T20:29:16Z","dateModified":"2022-03-21T20:29:16Z","author":{"@type":"Person","name":"Samuel Wallace"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/"},"publisher":{"@type":"Organization","name":"wallaceLabs","logo":{"@type":"ImageObject","url":"https://wallacelabs.tech/favicon.ico"}}}</script>
</head><body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://wallacelabs.tech accesskey=h title="> wallaceLabs (Alt + H)">> wallaceLabs</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div><ul id=menu>
<li>
<a href=https://wallacelabs.tech/archives/ title=archives>
<span>archives</span>
</a>
</li><li>
<a href=https://wallacelabs.tech/categories/ title=categories>
<span>categories</span>
</a>
</li><li>
<a href=https://wallacelabs.tech/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li><li>
<a href=https://wallacelabs.tech/tags/ title=tags>
<span>tags</span>
</a>
</li></ul></nav></header><main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://wallacelabs.tech>Home</a>&nbsp;»&nbsp;<a href=https://wallacelabs.tech/posts/>Posts</a></div><h1 class=post-title>
Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN
</h1><div class=post-meta><span title="2022-03-21 20:29:16 +0000 UTC">March 21, 2022</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Samuel Wallace&nbsp;|&nbsp;<a href=https://github.com/swallace17/wallacelabs.site/tree/main/content/posts/Operating%20an%20Unraid-Hosted,%20Containerized%20Wireguard%20VPN%20Server%20on%20a%20VLAN/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div></header><figure class=entry-cover>
<img loading=lazy srcset="https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/cover_hud35c7d46460d95af8ddaca1bca70e7bf_84355_360x0_resize_box_3.png 360w ,https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/cover_hud35c7d46460d95af8ddaca1bca70e7bf_84355_480x0_resize_box_3.png 480w ,https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/cover_hud35c7d46460d95af8ddaca1bca70e7bf_84355_720x0_resize_box_3.png 720w ,https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/cover_hud35c7d46460d95af8ddaca1bca70e7bf_84355_1080x0_resize_box_3.png 1080w ,https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/cover.png 1200w" sizes="(min-width: 768px) 720px, 100vw" src=https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/cover.png alt width=1200 height=630>
<p></p></figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#implementation-considerations aria-label="Implementation Considerations">Implementation Considerations</a></li><li>
<a href=#making-it-happen aria-label="Making It Happen">Making It Happen</a></li><li>
<a href=#the-problem aria-label="The Problem">The Problem</a></li><li>
<a href=#eating-my-words aria-label="Eating My Words">Eating My Words</a>
</li></ul></div></details>
</div><div class=post-content><p>I run my home network on Ubiquiti UniFi based hardware utilizing a UniFi Dream Machine Pro (UDMP) as my gateway/firewall, along with an assortment of UniFi Access Points (APs) and managed switches. In the event that I need to remote into my network, my gateway operates an L2TP over IPsec VPN. Using the built in Radius server, I&rsquo;ve been able to configure this VPN so that remote clients are automatically routed to a specific subnet via a VLAN tag. This has been great, because I can give myself access to my full network, while limiting other clients to isolated sections of my network as desired.</p><p>Recently, however, I began testing Ubiquiti&rsquo;s UID (UniFi Identity) product as an Early Access member. I won&rsquo;t spend too much time on this, as the product is very much still in development (and I believe the Early Access terms of service prevent me from doing so anyway), but suffice it to say that utilizing UID has put a temporary crimp in my normal VPN operations. In short, the UID platform, when integrated on my firewall, runs all VPN authentication through its identity management platform (which can integrate with LDAP, Active Directory, etc). This functionality is very cool, but not fully fleshed out yet. My problem is that, for the time being, there is no way to assign a given user a vlan tag. This prevents me from locking certain users to particular subnets where firewall rules prevent them from accessing the network at large.</p><p>Ubiquiti has confirmed that this functionality will be coming eventually, but in the meantime I&rsquo;m stuck, as tagging VPN users to a vlan is something I regularly need to do. It is with all this in mind that I began considering operating a second VPN server directly from an isolated subnet as a temporary work-around.</p><h2 id=implementation-considerations>Implementation Considerations<a hidden class=anchor aria-hidden=true href=#implementation-considerations>#</a></h2><p>With an action plan worked out, I fiddled around with a few different approaches. I briefly considered setting up an OpenVPN server, but quickly moved on to Wireguard due to its security, speed, and relative simplicity.</p><p>Operating the server as a Docker container was also a big deal, as I have containerized practically all of my Homelab&rsquo;s infrastructure at this point. Generally speaking, if I can&rsquo;t run it as a container, I&rsquo;ll find another solution. Dedicated application environments are too important, and accomplishing this isolation with Virtual Machines is too resource-expensive for it to be an ongoing solution. Containers or bust!</p><p>Lastly, I wanted to run all this using my Unraid Server as a host. For the unfamiliar, Unraid is a Linux based OS focused on enabling Network Attached Storage (NAS) functions and VM/Container hosting. My Unraid server is where I host a good deal of containerized infrastructure for my home&ndash; no reason to run this Wireguard server anywhere else.</p><blockquote>
<p><em>Note:</em> The Unraid OS actually has a <a href=https://unraid.net/de/blog/wireguard-on-unraid>built-in Wireguard server</a>. Why not just use that? In theory, I could, and I did try. The reason I am not is because my goal in all of this is to have clients connected to this VPN restricted to a given subnet. Unfortunately, any clients connected to Unraid&rsquo;s built-in Wireguard server end up on the same subnet as the Unraid server itself. In my case, my Unraid server is connected to an untagged network port, and thus is on my primary LAN network, not on a restricted subnet where I want these clients to end up. As of the time of writing, there is no way to assign the built-in Wireguard service to a virtual, vlan-tagged network interface. The good news is that Unraid OS does support assigning vlan-tagged virtual network interfaces to any VM or container it hosts&ndash; thus my goal of operating a Wireguard server as a container.</p></blockquote><h2 id=making-it-happen>Making It Happen<a hidden class=anchor aria-hidden=true href=#making-it-happen>#</a></h2><p>The first step in getting this server online was to find a Docker Image designed for creating a containerized Wireguard server.</p><blockquote>
<p>I initially thought I&rsquo;d build one by hand, and got most of the way through the process before deciding it wasn&rsquo;t worth the effort for what will ultimately be a temporary solution anyway. That being said, I learned a lot, and if you&rsquo;d like to set down that path yourself, I fully recommend following <a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04>this excellent guide</a> written by Jamon Camisso at Digital Ocean.</p></blockquote><p>After a bit of research, there were a couple images I was considering. The first was <a href=https://github.com/linuxserver/docker-wireguard>docker-wireguard</a> by the great <a href=https://www.linuxserver.io/>LinuxServer.io group</a>. Second, and what I&rsquo;ve ended up going with, is <a href=https://github.com/WeeJeWel/wg-easy/>wg-easy</a>. The linuxserver.io wireguard container is more flexible, but wg-easy ended up being easier for my purposes, and offers the great benefit of hosting a cool web-management panel for creating client connections, viewing their QR codes, downloading their configuration files, etc. All things that can be trivially done via CLI, but the GUI web panel makes things a bit easier, and prettier for every-day use.</p><p>Great, I found an image on DockerHub that does exactly what I need it to. All thats left is to get it running on my Unraid server, right? Unfortunately, thats not where this story ends.</p><h2 id=the-problem>The Problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>Recall that the whole point of this endeavor was to give VPN clients access to a subnet of my network only, not the whole thing. Furthermore, recall that any clients connected to the Wireguard server will have access to the same network the Wireguard server itself resides on. With that in mind, the only way to restrict Wireguard clients to a given subnet is to operate the Wireguard server on that same subnet.</p><blockquote>
<p><em>Note:</em> This limitation could be avoided if the wireguard server were being run on the gateway/router, but UniFi does not currently support running a Wireguard server, and again there is the complication introduced by UID. All of this is a long way of saying if you have a PFSense gateway (or another gateway that supports operating a wireguard server), you could probably work around this issue. Beyond that, you could probably get it working with a multi-gateway type setup, with a dedicated PFsense box that handles some routing, but is not your primary &ldquo;router&rdquo;, per se&mldr; but that is entering into a world of networking complexity that goes <em>far</em> beyond the scope of this post. A post for another day, perhaps.</p></blockquote><p>So, I&rsquo;ve got a Wireguard server docker container. How do I go about getting it on the correct subnet? The best way to get this container on my subnet of choice is to run the container using host networking mode, instead of bridge. On the host, I created a virtual network interface, tagged it to the relevant vlan, and assigned that interface to my container running in host networking mode. Simple enough, right? Well, it should be. Creating the interface is <a href=https://forums.unraid.net/topic/62107-network-isolation-in-unraid-64/>no big deal</a> on Unraid. Just have to open up the Unraid web-management panel, navigate to <code>Settings-->Network Settings</code>, enable VLANS, and configure a virtual interface to be tagged to a vlan, as seen below:</p><figure class=align-center>
<img loading=lazy src=vInterface.png#center>
</figure><p>The same thing should also be simple enough to implement <a href=http://woshub.com/configure-multiple-vlan-on-windows/>on Windows</a>, <a href=https://support.apple.com/en-vn/guide/mac-help/mh15134/mac>on macOS</a>, or <a href=https://sleeplessbeastie.eu/2019/12/20/how-to-create-vlan-interface-using-the-ip-utility/>generically on Linux</a>. That being said, I have not tested it. This walk-through is assuming the use of Unraid, I just wanted to make it clear that there&rsquo;s no reason this could not be done on another platform.</p><p>Here is the problem- the wg-easy container does not run correctly when configured to run in host-networking mode. The container starts up correctly, the Wireguard server runs, and clients can even connect- but they cannot seem to pass any data. I&rsquo;ve been unable to determine a solution, and not for lack of trying. There is <a href=https://github.com/WeeJeWel/wg-easy/issues/218>an open issue</a> on the container&rsquo;s Github page, and I&rsquo;ve asked around on the container&rsquo;s <a href=https://forums.unraid.net/topic/117195-support-smartphonelover-wireguard-easy/#comment-1070763>support page on the Unraid Forums</a>. So far, nothing has proved useful.</p><p>I have not made much headway, but I&rsquo;m still hoping to find a solution. Though I am reluctant to give up on the convince of the web-management panel, I&rsquo;ve been considering trying the LinuxServer.io Wireguard container (with host networking) and seeing if that works. If it does, it might prove helpful in determining what is wrong in wg-easy when running host networking. I&rsquo;ve also considered revisiting building a wireguard server container from scratch, hoping it might give me a better &ldquo;under the hood&rdquo; understanding of wireguard such that I can better determine what is breaking in wg-easy when running in host networking.</p><p>Ultimately, unless someone else posts a solution on Github, solving this issue is going to involve some degree of reverse engineering the wg-easy container, and and I go back and forth on whether its worth the time investment. This was supposed to be a quick, temporary solution! It has turned into a whole project, like these things often do</p><h2 id=eating-my-words>Eating My Words<a hidden class=anchor aria-hidden=true href=#eating-my-words>#</a></h2><p>In the meantime, to solve my problem day to day, I have been eating my words about only running infrastructure inside containers. I setup a Linux VM on my Unraid server, and installed Docker on that VM for some nested virtualization action. Still using containers! Just nested inside a VM, unfortunately. This solves my problem because I am able to assign the VLAN tagged virtual network interface to the VM. Then, when the container runs with bridge networking inside the VM, any connected Wireguard clients end up on the correct subnet, just as I&rsquo;ve been hoping to achieve this whole time. Its all a bit more convoluted than I would like, but it works nonetheless.</p><p>If you would like to implement a similar solution, it should be fairly simple. First, log on to Unraid and navigate to <code>Settings-->Network Settings</code>, enable VLANS, and configure a virtual interface to be tagged to a vlan (as discussed earlier).</p><blockquote>
<p><em>Quick Aside:</em> Be aware that you&rsquo;ll need to make sure the network port your Unraid server is connected to is configured for both your untagged native network, and tagged for your desired vlan. It might even make sense to set it up as a trunk port (carries all vlans) if you intend to use all vlans on your Unraid server for different VM&rsquo;s, containers, etc. Alternately, if your server has multiple network ports (via a dedicated PCIe NIC, or the like), you could just connect your server to multiple ports and use dedicated physical interfaces. Lots of options here.</p></blockquote><p>Then, configure a VM of your choice. I initially setup a Windows 11 VM for this, being curious how WSL and Docker Desktop would behave utilizing nested virtualization. Turns out, the answer is not well. The VM maxes out all assigned CPU cores and freezes up after a few minutes idle. Did some cursory troubleshooting, and there <a href=https://forums.unraid.net/bug-reports/prereleases/windows-11-vm-freezes-after-several-minutes-idle-6100-rc2-r1667/>appears to be no solution</a> at the moment. With that in mind, I&rsquo;d recommend a Linux OS. Ubuntu or Debian are usually my go-to for a quick VM, but its really just preference. Just make sure to assign your vlan tagged virtual network interface to that VM.</p><p>With your VM running, <a href=https://docs.docker.com/engine/install/>install Docker</a>, and follow the instructions on the <a href=https://github.com/WeeJeWel/wg-easy/>wg-easy Github page</a> to get your Wireguard server running. When you&rsquo;re done, you&rsquo;ll have a wireguard server running such that all connecting clients are restricted to your desired subnet. Mission accomplished!</p><p>I hope you might find my documented struggles here useful, or entertaining at the very least. If you happen to have a solution to running wg-easy in host networking mode, please let me know! I&rsquo;d be thrilled. Just hit me up on the Github issue I linked earlier, or on the site&rsquo;s <a href=https://discord.gg/RvGUzxAyST>Discord server</a>. Thanks!</p></div><footer class=post-footer>
<ul class=post-tags>
<li><a href=https://wallacelabs.tech/tags/unraid/>Unraid</a></li><li><a href=https://wallacelabs.tech/tags/wireguard/>Wireguard</a></li><li><a href=https://wallacelabs.tech/tags/subnet/>subnet</a></li><li><a href=https://wallacelabs.tech/tags/vlan/>VLAN</a></li><li><a href=https://wallacelabs.tech/tags/containers/>Containers</a></li></ul><nav class=paginav>
<a class=next href=https://wallacelabs.tech/posts/exploring-google-workspace-upload-limits/>
<span class=title>Next Page »</span>
<br>
<span>Exploring Google Workspace Upload Limits</span>
</a>
</nav><div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN on twitter" href="https://twitter.com/intent/tweet/?text=Operating%20an%20Unraid-Hosted%2c%20Containerized%20Wireguard%20VPN%20Server%20on%20a%20VLAN&url=https%3a%2f%2fwallacelabs.tech%2fposts%2foperating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan%2f&hashtags=Unraid%2cWireguard%2csubnet%2cVLAN%2cContainers"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwallacelabs.tech%2fposts%2foperating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan%2f&title=Operating%20an%20Unraid-Hosted%2c%20Containerized%20Wireguard%20VPN%20Server%20on%20a%20VLAN&summary=Operating%20an%20Unraid-Hosted%2c%20Containerized%20Wireguard%20VPN%20Server%20on%20a%20VLAN&source=https%3a%2f%2fwallacelabs.tech%2fposts%2foperating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwallacelabs.tech%2fposts%2foperating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan%2f&title=Operating%20an%20Unraid-Hosted%2c%20Containerized%20Wireguard%20VPN%20Server%20on%20a%20VLAN"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwallacelabs.tech%2fposts%2foperating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN on whatsapp" href="https://api.whatsapp.com/send?text=Operating%20an%20Unraid-Hosted%2c%20Containerized%20Wireguard%20VPN%20Server%20on%20a%20VLAN%20-%20https%3a%2f%2fwallacelabs.tech%2fposts%2foperating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN on telegram" href="https://telegram.me/share/url?text=Operating%20an%20Unraid-Hosted%2c%20Containerized%20Wireguard%20VPN%20Server%20on%20a%20VLAN&url=https%3a%2f%2fwallacelabs.tech%2fposts%2foperating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div></footer></article></main><footer class=footer>
<span>&copy; 2022 <a href=https://wallacelabs.tech>wallaceLabs</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script>
<script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script>
</body></html>