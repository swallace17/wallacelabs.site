<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Fulfilling Smart Lighting's Natural Purpose | wallaceLabs</title><meta name=keywords content="Phillips Hue,Home Assistant,Circadian Lighting,Scripting">
<meta name=description content="I was originally going to title this post &ldquo;Optimizing the Circadian Lighting Home Assistant Integration for use with Phillips Hue.&rdquo; Thats the core of what the below is all about, but I eventually reconsidered, thinking it sounded a bit too much like jargon soup. So, before getting too into the weeds, lets begin by talking generally about smart lighting in the home.
In my ongoing journey to create an ever more integrated smart-home, I have opted to utilize the Phillips Hue platform for my lighting.">
<meta name=author content="Samuel Wallace">
<link rel=canonical href=https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://wallacelabs.tech/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://wallacelabs.tech/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://wallacelabs.tech/favicon-32x32.png>
<link rel=apple-touch-icon href=https://wallacelabs.tech/apple-touch-icon.png>
<link rel=mask-icon href=https://wallacelabs.tech/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Fulfilling Smart Lighting's Natural Purpose">
<meta property="og:description" content="I was originally going to title this post &ldquo;Optimizing the Circadian Lighting Home Assistant Integration for use with Phillips Hue.&rdquo; Thats the core of what the below is all about, but I eventually reconsidered, thinking it sounded a bit too much like jargon soup. So, before getting too into the weeds, lets begin by talking generally about smart lighting in the home.
In my ongoing journey to create an ever more integrated smart-home, I have opted to utilize the Phillips Hue platform for my lighting.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/">
<meta property="og:image" content="https://wallacelabs.tech/cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-04-17T03:55:50+00:00">
<meta property="article:modified_time" content="2022-04-17T03:55:50+00:00"><meta property="og:site_name" content="wallaceLabs">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://wallacelabs.tech/cover.png">
<meta name=twitter:title content="Fulfilling Smart Lighting's Natural Purpose">
<meta name=twitter:description content="I was originally going to title this post &ldquo;Optimizing the Circadian Lighting Home Assistant Integration for use with Phillips Hue.&rdquo; Thats the core of what the below is all about, but I eventually reconsidered, thinking it sounded a bit too much like jargon soup. So, before getting too into the weeds, lets begin by talking generally about smart lighting in the home.
In my ongoing journey to create an ever more integrated smart-home, I have opted to utilize the Phillips Hue platform for my lighting.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://wallacelabs.tech/posts/"},{"@type":"ListItem","position":3,"name":"Fulfilling Smart Lighting's Natural Purpose","item":"https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fulfilling Smart Lighting's Natural Purpose","name":"Fulfilling Smart Lighting\u0027s Natural Purpose","description":"I was originally going to title this post \u0026ldquo;Optimizing the Circadian Lighting Home Assistant Integration for use with Phillips Hue.\u0026rdquo; Thats the core of what the below is all about, but I eventually reconsidered, thinking it sounded a bit too much like jargon soup. So, before getting too into the weeds, lets begin by talking generally about smart lighting in the home.\nIn my ongoing journey to create an ever more integrated smart-home, I have opted to utilize the Phillips Hue platform for my lighting.","keywords":["Phillips Hue","Home Assistant","Circadian Lighting","Scripting"],"articleBody":"I was originally going to title this post “Optimizing the Circadian Lighting Home Assistant Integration for use with Phillips Hue.” Thats the core of what the below is all about, but I eventually reconsidered, thinking it sounded a bit too much like jargon soup. So, before getting too into the weeds, lets begin by talking generally about smart lighting in the home.\nIn my ongoing journey to create an ever more integrated smart-home, I have opted to utilize the Phillips Hue platform for my lighting. Generally speaking, I recommend against using smart bulbs, in favor of smart switches from Lutron’s Caseta platform. In my home though, I go against my own advice. I do so because of how much I value the dynamic color, and color temperature functions offered by the Hue ecosystem. Yes, the bulbs are expensive, and their fixtures and other accessories generally even more so. You also run into the issue of having to keep your physical light switches always toggled on. The smart bulbs, after all, effectively have tiny little computers inside them that need constant power to function. Hue has a $40 product which removes that irritation, but of course, that requires spending even more money on this ecosystem, in addition to popping open switch boxes and doing some rewiring. You really gotta commit– and I have– but take that as a cautionary tale. If you can live without dynamic color and color temperature, smart switches are really the way to go.\n And its worth repeating- if you want smart switches, don’t waste your time on anything other than Lutron’s Caseta line). No sponsorships here, its just a solid product.\n Cautionary tale out of the way, if you have also chosen to use Hue for your lighting, you may have found yourself wishing that you could set your lights to automatically adjust their color temperature throughout the day. Warmer tones at night, and cooler ones during the day, for example. Its an increasingly popular concept. In a perfect world, what I would like is for lights to be cool and bright during the day, slowly transition to warmer with the movement of the sun across the horizon, and gradually become a bit dimmer as the night draws on. Doesn’t seem too difficult, right? To me, this seems like The Natural Purpose of Smart Lighting.\n“Time-Based Light” Hue Formula For years, Phillips has offered a basic version of this functionality through the Time-Based light formula (formerly “Feel Better With Light”) in the “My Labs” portion of the Hue app. This functionality is a bit limited though. All it really does is switch through a few pre-determined scenes at specified times of day. It actually works really well. It’s reliable, is quite simple to setup, and runs entirely on the Hue Bridge, no additional hardware or software integrations needed.\nFor any “normal person”, this would “fulfill smart lighting’s natural purpose” just fine. In fact, this is the solution I generally recommend for anyone who wants automatically adjusting color temperature in their lights. I’ve actually set it up for my parents, with a Hue starter set I gifted them after they completed a minor remodel of their bedroom a few years back. Far as I know, they’ve never had an issue, and really enjoy the “daylight bulbs” during the day, and “warm bulbs” after 6pm or so. In an effort to make my own life as difficult as possible, however, I can’t be content with this for myself. What I want is a smooth transition from cool to warm as the day goes on, not single trigger point where we switch from “cool mode” to “warm mode.” So what else is there to consider?\nApple’s “Adaptive Lighting” Apple, with iOS 14 at WWDC 2020, announced a HomeKit feature called Adaptive Lighting. Initially, it seemed like this feature was going to be great. My ongoing to-do item of “fulfilling smart lighting’s natural purpose”? Check! Or so I had hoped. In typical Apple fashion, the feature launched with basic functionality and little to no customization options– and the basic functionality it does have? Well, it doesn’t make much sense to me. Apple’s Adaptive Lighting works with Hue lights through the Homekit platform. During the brief time I tested it, it seemed to work well and reliably. But what does it actually do? With Adaptive Lighting, color temperature changes are inherently tied to changes in brightness. Basically, if you turn the brightness down, the light becomes warmer. If you make a light bright, the color temperature of the light becomes cooler. I’m sure this is functionality that someone wants, but it makes no sense to me. Moving on.\nCircadian Lighting Since 2019, the only method I have found that even comes close to meeting my needs is a Home Assistant integration called Circadian Lighting. It’s awesome, but boy does it ever up the complexity level. To use it, you’ll need a hardware server capable of running Home Assistant. This can be as simple as a raspberry pi, or you can run it as a docker container on whatever host you like.\n If you are not familiar with Home Assistant, and you have a vested interest in home automation, you’ll want to get familiar. In short, it ties together all the various home automation platforms from Apple, Google, Amazon, etc, and lets them all coexist and integrate together under one roof. There’s a learning curve, but the payoff is worth it, and if you’re reading this to begin with, its likely right up your alley.\n Circadian lighting does it all, and it very customizable to boot. It ties in to the Home Assistant platform, and allows me to fully “fulfill my smart lighting’s natural purpose”. I first started using it in 2019, a week or so after I moved into my first apartment, configuring it at 2am the night before my wedding. Good times! I’ve been using Circadian Lighting ever since, and haven’t found anything better.\n The only thing that has even gotten close is an extremely similar integration called Adaptive Lighting. It has a few extra features, but nothing that impacts my usage. I believe it started as a fork of Circadian Lighting, and both are actively maintained. I’d recommend checking out both, and seeing what will best fit your needs, but for now I’m still using Circadian Lighting.\n Circadian Lighting’s Only Hiccup I’ve only had one hiccup with Circadian Lighting, and solving it is what this post is all about. Circadian Lighting smoothly transitions the color temperature of lights throughout the day, just like I want. However, it only smoothly adjust the temperature of lights which are turned on. What happens if I turn a light off at noon, and flip it back on at 9pm? That light will very briefly turn on to “daylight mode” (however it was configured at noon, when it was last on). Then, the Home Assistant server will see that the light has been toggled on, and Circadian lighting will kick in and adjust it to the “correct” setting for whatever time of day it is. The whole process takes only a couple of seconds at most. Far from the end of the world. But look, you’re reading a 3000 word freakin’ essay about my light bulbs- of course this began to grate on me. I had come so far! Anything but lighting perfection was unacceptable.\nThe Fork Solution In October of 2019, my brother-in-law Robert and I worked out a solution in this Github issue on the topic, along with another user, Bluefries. It was an exciting moment when we got it working, late one night. Basically, what we did is configure Circadian Lighting to dynamically update a Hue Scene every time it updated the color temperature value for lights throughout the day. We then programmed our Hue Light switches to turn lights on to this scene whenever the button was pressed, and problem solved! The lights would instantly turn on to the correct setting, no delay.\nLong story short though, the modification involved changing some code in Circadian Lighting. We spoke with the developer about submitting a pull request, but they wanted to solve this problem in a different way (for reasons that make sense, but are beyond the scope of this discussion). So a pull request was never submitted. Over time, updates to Circadian lighting would break the modification, and we’d have to work out a fix. Eventually, we resorted to simply running an old version of Circadian Lighting to maintain compatibility with our modification.\nRobert forked the project, and I believe still has the modification working, but I’d ideally like to solve this issue without having to maintain an ongoing fork of the project.\nAutomation Solution This is where the Home Assistant platform becomes very helpful. In short, I’ve managed to write a Home Assistant automation which solves this issue by utilizing both the Circadian Lighting custom integration and the Hue integration, without modifying either of them. I believe this solution is closer to what Circadian Lighting’s developer originally wanted to implement and document, but never got around to.\nSo, lets talk about the automation. To start, the automation is triggered by a light switch being toggled. Then calculates a color temperature and brightness value based data provided by the home assistant sensor entity created by the Circadian Lighting integration. It then finishes by setting Home Assistant Light Entities (provided by the Phillips Hue integration) to the calculated color temperature and brightness. All of this happens outside of the Circadian Lighting integration itself, so it should work regardless of future updates, etc.\nGenerally speaking, this approach works great, and I’m proud of what I feel is a pretty clever solution. I think its cool that an automation can work with two independently developed Home Assistant Integrations to bridge a functionality gap between them. That being said, there are downsides to this approach. Namely, some occasional significant latency. When I flip on a light switch configured with this integration, the lights generally switch on instantly. Every once in awhile though, I’ll have to flip it a second time for the integration to trigger. Or, if you flip back and forth quickly, it can become overloaded, and you’ll have to pause a moment before flipping the switch again for it to work properly. Mostly minor annoyances, but suffice it to say, not the level of reliability I would prefer. Also, because the light switches are toggling a Home Assistant automation– well, if your Home Assistant server is offline, for any reason, now your light switches don’t work. Thats… not ideal. I’ve accepted those issues for now though. The latency is rare, and my Home Assistant server has near 100% uptime. So, lets get into the solution.\nAutomation Examples The automation code will differ slightly depending on what type of Hue Switch you are using. I have created examples for the Hue Dimmer Switch, the Hue In-Wall Module, and the Lutron Aurora “Friends of Hue” switch. Other switches should be simple enough to add support for with a bit of tweaking. Lets start with the Hue Dimmer.\n#Automatically turn Lights ON to CL setting when designated Hue Dimmer button is pressed - alias: HueCL - *Room* Switch - ON  description: HueCL for *Room* Lights  mode: single  trigger:  - device_id: *DeviceID* #(device_id can be found in the URL of a given device when pulled up in HA Web UI)  domain: hue  platform: device  type: initial_press  subtype: 1 #Hue dimmer switch buttons, 1-4, top to bottom  action:  service: light.turn_on  data_template:  entity_id: light.room  kelvin: \"{{ state_attr('sensor.circadian_values', 'colortemp') | int }}\"  brightness_pct: '{{ state_attr(''switch.circadian_lighting_circadian_lighting'', ''brightness'') | int }}' This automation is intended to run when you press the “On” button on a given Hue Dimmer switch. I’ve tried to comment things as best I can inline in the YAML, but lets discuss a bit. First off, the alias and description lines can be customized to whatever you like for labeling purposes. Next up, things that actually need to be changed in order to use this automation successfully. First off, underneath the trigger: line, the *DeviceID* tag needs to be swapped out with an actual device ID as listed in Home Assistant. To determine this device ID, open up your Home Assistant web interface. Navigate to Settings–Devices and Services–Devices. Click on the switch you’re looking to automate, and the DeviceID will a long string of characters at the end of that page’s URL, as seen in the image below.\n Device ID can be found circled in red, in the URL bar\n  From there, you may want to change the subtype: line. This is where you choose which button on the Hue dimmer you are using to trigger the automation. They are numbered 1-4, top to bottom. You will probably want to leave this on 1, using the top switch to turn on the lights.\nOnly two more things that will need changing. The first is entity_id. The Hue Home Assistant integration creates an entity for every room with lights in it. To find the entity ID of a given room’s lights, navigate to Settings–Devices and Services–Entities. Find the entity which corresponds to your room’s lights, click on it, and the entity ID will be listed. It should be in the rough format I listed in the code above. Lastly, in the brightness_pct: line, you will see the switch.circadian_lighting_circadian_lighting string. This is the entity ID of the switch created by the Circadian Lighting custom integration. Pull up your list of entities again, and search for Circadian Lighting. You should see the switch there, and be able to verify its entity ID.\nWith those changes made, you should be good to go. All thats left now is to setup the automation for the off button now as well– see below:\n#Turn Lights OFF when designated Hue Dimmer button is pressed - alias: HueCL - *Room* Switch - OFF  description: HueCL for *Room* Lights  mode: single  trigger:  - device_id: *DeviceID* #(device_id can be found in the URL of a given device when pulled up in HA Web UI)  domain: hue  platform: device  type: initial_press  subtype: 4 #Hue dimmer switch buttons, 1-4, top to bottom  action:  service: light.turn_off  data_template:  entity_id: light.room Make changes here the same way as those above, and you’ve got a dimmer switch setup. Rinse and repeat for other Dimmer switches. But what if you have a switch without multiple buttons? For example, the Hue In-Wall switch, or the Lutron Aurora? These switches only have a single button which is used to toggle the lights on/off with each press. They can be used with a single automation that incorporates a bit of if/else logic for the toggle functions. See below:\n#Automatically turn Lights ON to CL setting when Toggle button is pressed (if lights are currently off), or turn lights off (if they are currently on) - alias: HueCL - Room Toggle  trigger:  - device_id: *DeviceID* #(device_id can be found in the URL of a given device when pulled up in HA Web UI)  domain: hue  platform: device  type: initial_press  subtype: 1 #Toggle button (Only one button)  mode: single  action:  - choose:  #Check if lights are off  - conditions:  - condition: state  entity_id: light.room  state: \"off\"  sequence:  - service: light.turn_on  data_template:  entity_id: light.room  kelvin: \"{{ state_attr('sensor.circadian_values', 'colortemp') | int }}\"  brightness_pct: '{{ state_attr(''switch.circadian_lighting_circadian_lighting'', ''brightness'') | int }}'  #Check if lights are on  - conditions:  - condition: state  entity_id: light.room  state: \"on\"  sequence:  - service: light.turn_off  data_template:  entity_id: light.room Just like before, you’ll need to setup DeviceID, entity_id, and circadian lighting switch entity ID. With those values swapped in, the automation should be functioning.\nThat about covers it! These automation have been key for me in eliminating lingering irritations with my smart lighting setup. Now I can use Circadian Lighting to fully realize what I’ve been referring to as “Smart Lightings Natural Purpose.” And, whenever I use a light switch to turn my lights on, they immediately switch on the the “correct” value as determined by Circadian Lighting. No delay! I hope these automations prove useful to you, either for a full solution, or as a starting point to something more complex.\nFuture Changes Earlier, I mentioned that latency is a downside to this approach. I wanted to take the time to document where this issue comes from. Consider the flow of data that has to happen for a light switch to turn on:\n Quite the process to get through every time you turn on a light\n  If its not readily apparent- thats quite the communication chain required to turn on a light. I mentioned this earlier, but to again elaborate:\nUsing this automation, usually my lights turn on/off near immediately, but occasionally there is a bit of a delay– maybe up to a second or two. Irritating. It also sometimes fails outright, and I’ll have to toggle the switch a second time. Lastly, if you toggle the switch back and forth quickly, it can get overloaded, and you’ll have to wait a few seconds, then flip the switch again for changes to be made.\nWith that long communication chain in mind, lets consider the original solution Robert and I worked on together, which he still maintains. While irritating to actively maintain, this solution is lower latency, and more reliable. In the above image, you can see that, using my HA automation solution, when a light switch is toggled, the circadian lighting sensor is queried, and there are all these hoops that have to be jumped through just for the lights to turn on to a particular value. With the original solution, the circadian lighting sensor entity is constantly updating a Hue scene by communicating with the Hue Bridge via the Hue API. That way, all the light switch has to do is pull a scene value from the Bridge. No hoops. Just request, and response. Much more efficient.\nThe perfect solution would have the efficiency of Robert’s fork solution, while achieving the goal of my automation solution and not touching Circadian Lighting’s code. Is that possible? I think so, and its only through documenting everything in this post that I’ve been able to clarify my thoughts on the matter.\nI’m envisioning configuring a Home Assistant automation which monitors the Circadian Lighting Sensor for changes. That would be the automation’s “trigger.” Whenever it sees a change in the Circadian Lighting Sensor entity, it would update a scene on the Hue bridge, just like the original fork solution. The complicated part is the mechanism by which it updates this scene.\nThe automation should be able to communicate with the Hue Bridge directly over the Hue API through REST commands. Otherwise, the automation could trigger a python script that does the same thing. From there, the switch itself would be configured via Hue to simply turn the light on to that scene when toggled. With that setup, we’d have the efficiency of the fork solution, without touching Circadian Lightings code, just as desired.\nIf its that easy, why haven’t I done it? Well, things are easy in theory. I’m far from an expert on complex Home Assistant automations, let alone working with the Hue API via REST commands, etc. Its going to require some experimentation, and a lot of trial and error. One of these days I’ll get around to it, and I’ll certainly write about it when I do. Maybe even finally put in that pull request! But in the meantime, I hope either the fork solution or the automation solution I’ve detailed here may be helpful to someone. Till next time!\n","wordCount":"3260","inLanguage":"en","image":"https://wallacelabs.tech/cover.png","datePublished":"2022-04-17T03:55:50Z","dateModified":"2022-04-17T03:55:50Z","author":{"@type":"Person","name":"Samuel Wallace"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/"},"publisher":{"@type":"Organization","name":"wallaceLabs","logo":{"@type":"ImageObject","url":"https://wallacelabs.tech/favicon.ico"}}}</script>
</head><body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://wallacelabs.tech accesskey=h title="> wallaceLabs (Alt + H)">> wallaceLabs</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div><ul id=menu>
<li>
<a href=https://wallacelabs.tech/archives/ title=archives>
<span>archives</span>
</a>
</li><li>
<a href=https://wallacelabs.tech/categories/ title=categories>
<span>categories</span>
</a>
</li><li>
<a href=https://wallacelabs.tech/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li><li>
<a href=https://wallacelabs.tech/tags/ title=tags>
<span>tags</span>
</a>
</li></ul></nav></header><main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://wallacelabs.tech>Home</a>&nbsp;»&nbsp;<a href=https://wallacelabs.tech/posts/>Posts</a></div><h1 class=post-title>
Fulfilling Smart Lighting's Natural Purpose<sup><span class=entry-isdraft>&nbsp;&nbsp;[draft]</span></sup>
</h1><div class=post-meta><span title="2022-04-17 03:55:50 +0000 UTC">April 17, 2022</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Samuel Wallace&nbsp;|&nbsp;<a href=https://github.com/swallace17/wallacelabs.site/tree/main/content/posts/Fulfilling%20Smart%20Lighting%27s%20Natural%20Purpose/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div></header><figure class=entry-cover>
<img loading=lazy srcset="https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/cover_huf0408e04ce7775f297be18de907b353d_1007242_360x0_resize_box_3.png 360w ,https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/cover_huf0408e04ce7775f297be18de907b353d_1007242_480x0_resize_box_3.png 480w ,https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/cover_huf0408e04ce7775f297be18de907b353d_1007242_720x0_resize_box_3.png 720w ,https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/cover_huf0408e04ce7775f297be18de907b353d_1007242_1080x0_resize_box_3.png 1080w ,https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/cover.png 1200w" sizes="(min-width: 768px) 720px, 100vw" src=https://wallacelabs.tech/posts/fulfilling-smart-lightings-natural-purpose/cover.png alt width=1200 height=630>
<p></p></figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#time-based-light-hue-formula aria-label="&amp;ldquo;Time-Based Light&amp;rdquo; Hue Formula">&ldquo;Time-Based Light&rdquo; Hue Formula</a></li><li>
<a href=#apples-adaptive-lighting aria-label="Apple&amp;rsquo;s &amp;ldquo;Adaptive Lighting&amp;rdquo;">Apple&rsquo;s &ldquo;Adaptive Lighting&rdquo;</a></li><li>
<a href=#circadian-lighting aria-label="Circadian Lighting">Circadian Lighting</a></li><li>
<a href=#circadian-lightings-only-hiccup aria-label="Circadian Lighting&amp;rsquo;s Only Hiccup">Circadian Lighting&rsquo;s Only Hiccup</a></li><li>
<a href=#the-fork-solution aria-label="The Fork Solution">The Fork Solution</a></li><li>
<a href=#automation-solution aria-label="Automation Solution">Automation Solution</a><ul>
<li>
<a href=#automation-examples aria-label="Automation Examples">Automation Examples</a></li></ul></li><li>
<a href=#future-changes aria-label="Future Changes">Future Changes</a>
</li></ul></div></details>
</div><div class=post-content><p>I was originally going to title this post &ldquo;Optimizing the Circadian Lighting Home Assistant Integration for use with Phillips Hue.&rdquo; Thats the core of what the below is all about, but I eventually reconsidered, thinking it sounded a bit too much like jargon soup. So, before getting too into the weeds, lets begin by talking generally about smart lighting in the home.</p><p>In my ongoing journey to create an ever more integrated smart-home, I have opted to utilize the Phillips Hue platform for my lighting. Generally speaking, I recommend against using smart bulbs, in favor of smart switches from Lutron&rsquo;s Caseta platform. In my home though, I go against my own advice. I do so because of how much I value the dynamic color, and color temperature functions offered by the Hue ecosystem. Yes, the bulbs are expensive, and their fixtures and other accessories generally even more so. You also run into the issue of having to keep your physical light switches always toggled on. The smart bulbs, after all, effectively have tiny little computers inside them that need constant power to function. Hue <a href=https://www.philips-hue.com/en-us/p/hue-philips-hue-wall-switch-module/046677571160>has a $40 product</a> which removes that irritation, but of course, that requires spending even more money on this ecosystem, in addition to popping open switch boxes and doing some rewiring. You really gotta commit&ndash; and I have&ndash; but take that as a cautionary tale. If you can live without dynamic color and color temperature, smart switches are really the way to go.</p><blockquote>
<p>And its worth repeating- if you want smart switches, don&rsquo;t waste your time on anything other than <a href=https://www.casetawireless.com/us/en>Lutron&rsquo;s Caseta line</a>). No sponsorships here, its just a solid product.</p></blockquote><p>Cautionary tale out of the way, if you have also chosen to use Hue for your lighting, you may have found yourself wishing that you could set your lights to automatically adjust their color temperature throughout the day. Warmer tones at night, and cooler ones during the day, for example. Its an increasingly popular concept. In a perfect world, what I would like is for lights to be cool and bright during the day, slowly transition to warmer with the movement of the sun across the horizon, and gradually become a bit dimmer as the night draws on. Doesn&rsquo;t seem too difficult, right? To me, this seems like <em>The Natural Purpose of Smart Lighting</em>.</p><h2 id=time-based-light-hue-formula>&ldquo;Time-Based Light&rdquo; Hue Formula<a hidden class=anchor aria-hidden=true href=#time-based-light-hue-formula>#</a></h2><p>For years, Phillips has offered a basic version of this functionality through the <a href=https://labs.meethue.com/formulas/huelabs/feel-better-with-light>Time-Based light</a> formula (formerly &ldquo;Feel Better With Light&rdquo;) in the &ldquo;My Labs&rdquo; portion of the Hue app. This functionality is a bit limited though. All it really does is switch through a few pre-determined scenes at specified times of day. It actually works really well. It&rsquo;s reliable, is quite simple to setup, and runs entirely on the Hue Bridge, no additional hardware or software integrations needed.</p><p>For any &ldquo;normal person&rdquo;, this would &ldquo;fulfill smart lighting&rsquo;s natural purpose&rdquo; just fine. In fact, this is the solution I generally recommend for anyone who wants automatically adjusting color temperature in their lights. I&rsquo;ve actually set it up for my parents, with a Hue starter set I gifted them after they completed a minor remodel of their bedroom a few years back. Far as I know, they&rsquo;ve never had an issue, and really enjoy the &ldquo;daylight bulbs&rdquo; during the day, and &ldquo;warm bulbs&rdquo; after 6pm or so. In an effort to make my own life as difficult as possible, however, I can&rsquo;t be content with this for myself. <a href="https://www.youtube.com/watch?v=KVUF_jC5wiU">What I want</a> is a smooth transition from cool to warm as the day goes on, not single trigger point where we switch from &ldquo;cool mode&rdquo; to &ldquo;warm mode.&rdquo; So what else is there to consider?</p><h2 id=apples-adaptive-lighting>Apple&rsquo;s &ldquo;Adaptive Lighting&rdquo;<a hidden class=anchor aria-hidden=true href=#apples-adaptive-lighting>#</a></h2><p>Apple, with iOS 14 at WWDC 2020, announced a HomeKit feature called Adaptive Lighting. Initially, it seemed like this feature was going to be great. My ongoing to-do item of &ldquo;fulfilling smart lighting&rsquo;s natural purpose&rdquo;? Check! Or so I had hoped. In typical Apple fashion, the feature launched with basic functionality and little to no customization options&ndash; and the basic functionality it does have? Well, it doesn&rsquo;t make much sense to me. Apple&rsquo;s Adaptive Lighting works with Hue lights through the Homekit platform. During the brief time I tested it, it seemed to work well and reliably. But what does it actually do? With Adaptive Lighting, color temperature changes are inherently tied to changes in brightness. Basically, if you turn the brightness down, the light becomes warmer. If you make a light bright, the color temperature of the light becomes cooler. I&rsquo;m sure this is functionality that someone wants, but it makes no sense to me. Moving on.</p><h2 id=circadian-lighting>Circadian Lighting<a hidden class=anchor aria-hidden=true href=#circadian-lighting>#</a></h2><p>Since 2019, the only method I have found that even comes close to meeting my needs is a Home Assistant integration called <a href=https://github.com/claytonjn/hass-circadian_lighting>Circadian Lighting</a>. It&rsquo;s awesome, but boy does it ever up the complexity level. To use it, you&rsquo;ll need a hardware server capable of running <a href=https://www.home-assistant.io/>Home Assistant</a>. This can be as simple as a raspberry pi, or you can run it as a docker container on whatever host you like.</p><blockquote>
<p>If you are not familiar with Home Assistant, and you have a vested interest in home automation, you&rsquo;ll want to get familiar. In short, it ties together all the various home automation platforms from Apple, Google, Amazon, etc, and lets them all coexist and integrate together under one roof. There&rsquo;s a learning curve, but the payoff is worth it, and if you&rsquo;re reading this to begin with, its likely right up your alley.</p></blockquote><p>Circadian lighting does it all, and it very customizable to boot. It ties in to the Home Assistant platform, and allows me to fully &ldquo;fulfill my smart lighting&rsquo;s natural purpose&rdquo;. I first started using it in 2019, a week or so after I moved into my first apartment, configuring it at 2am the night before my wedding. Good times! I&rsquo;ve been using Circadian Lighting ever since, and haven&rsquo;t found anything better.</p><blockquote>
<p>The only thing that has even gotten close is an extremely similar integration called <a href=https://github.com/basnijholt/adaptive-lighting>Adaptive Lighting</a>. It has a few extra features, but nothing that impacts my usage. I believe it started as a fork of Circadian Lighting, and both are actively maintained. I&rsquo;d recommend checking out both, and seeing what will best fit your needs, but for now I&rsquo;m still using Circadian Lighting.</p></blockquote><h2 id=circadian-lightings-only-hiccup>Circadian Lighting&rsquo;s Only Hiccup<a hidden class=anchor aria-hidden=true href=#circadian-lightings-only-hiccup>#</a></h2><p>I&rsquo;ve only had one hiccup with Circadian Lighting, and solving it is what this post is all about. Circadian Lighting smoothly transitions the color temperature of lights throughout the day, just like I want. However, it only smoothly adjust the temperature of lights which are turned on. What happens if I turn a light off at noon, and flip it back on at 9pm? That light will very briefly turn on to &ldquo;daylight mode&rdquo; (however it was configured at noon, when it was last on). Then, the Home Assistant server will see that the light has been toggled on, and Circadian lighting will kick in and adjust it to the &ldquo;correct&rdquo; setting for whatever time of day it is. The whole process takes only a couple of seconds at most. Far from the end of the world. But look, you&rsquo;re reading a 3000 word freakin&rsquo; essay about my light bulbs- of course this began to grate on me. I had come so far! Anything but lighting perfection was unacceptable.</p><h2 id=the-fork-solution>The Fork Solution<a hidden class=anchor aria-hidden=true href=#the-fork-solution>#</a></h2><p>In October of 2019, my brother-in-law Robert and I worked out a solution in <a href=https://github.com/claytonjn/hass-circadian_lighting/issues/3>this Github issue</a> on the topic, along with another user, Bluefries. It was an exciting moment when we got it working, late one night. Basically, what we did is configure Circadian Lighting to dynamically update a Hue Scene every time it updated the color temperature value for lights throughout the day. We then programmed our Hue Light switches to turn lights on to this scene whenever the button was pressed, and problem solved! The lights would instantly turn on to the correct setting, no delay.</p><p>Long story short though, the modification involved changing some code in Circadian Lighting. We spoke with the developer about submitting a pull request, but they wanted to solve this problem in a different way (for reasons that make sense, but are beyond the scope of this discussion). So a pull request was never submitted. Over time, updates to Circadian lighting would break the modification, and we&rsquo;d have to work out a fix. Eventually, we resorted to simply running an old version of Circadian Lighting to maintain compatibility with our modification.</p><p>Robert <a href=https://github.com/RobertDWhite/circadian_lighting-hue>forked the project</a>, and I believe still has the modification working, but I&rsquo;d ideally like to solve this issue without having to maintain an ongoing fork of the project.</p><h2 id=automation-solution>Automation Solution<a hidden class=anchor aria-hidden=true href=#automation-solution>#</a></h2><p>This is where the Home Assistant platform becomes very helpful. In short, I&rsquo;ve managed to write a Home Assistant automation which solves this issue by utilizing both the Circadian Lighting custom integration and the Hue integration, without modifying either of them. I believe this solution is closer to what Circadian Lighting&rsquo;s developer originally wanted to implement and document, but never got around to.</p><p>So, lets talk about the automation. To start, the automation is triggered by a light switch being toggled. Then calculates a color temperature and brightness value based data provided by the home assistant sensor entity created by the Circadian Lighting integration. It then finishes by setting Home Assistant Light Entities (provided by the Phillips Hue integration) to the calculated color temperature and brightness. All of this happens outside of the Circadian Lighting integration itself, so it should work regardless of future updates, etc.</p><p>Generally speaking, this approach works great, and I&rsquo;m proud of what I feel is a pretty clever solution. I think its cool that an automation can work with two independently developed Home Assistant Integrations to bridge a functionality gap between them. That being said, there are downsides to this approach. Namely, some occasional significant latency. When I flip on a light switch configured with this integration, the lights generally switch on instantly. Every once in awhile though, I&rsquo;ll have to flip it a second time for the integration to trigger. Or, if you flip back and forth quickly, it can become overloaded, and you&rsquo;ll have to pause a moment before flipping the switch again for it to work properly. Mostly minor annoyances, but suffice it to say, not the level of reliability I would prefer. Also, because the light switches are toggling a Home Assistant automation&ndash; well, if your Home Assistant server is offline, for any reason, now your light switches don&rsquo;t work. Thats&mldr; not ideal. I&rsquo;ve accepted those issues for now though. The latency is rare, and my Home Assistant server has near 100% uptime. So, lets get into the solution.</p><h3 id=automation-examples>Automation Examples<a hidden class=anchor aria-hidden=true href=#automation-examples>#</a></h3><p>The automation code will differ slightly depending on what type of Hue Switch you are using. I have created examples for the Hue Dimmer Switch, the Hue In-Wall Module, and the Lutron Aurora &ldquo;Friends of Hue&rdquo; switch. Other switches should be simple enough to add support for with a bit of tweaking. Lets start with the Hue Dimmer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#75715e>#Automatically turn Lights ON to CL setting when designated Hue Dimmer button is pressed</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>alias</span>: <span style=color:#ae81ff>HueCL - *Room* Switch - ON</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>HueCL for *Room* Lights</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>single</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>trigger</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>device_id</span>: <span style=color:#75715e>*DeviceID*</span> <span style=color:#75715e>#(device_id can be found in the URL of a given device when pulled up in HA Web UI)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>domain</span>: <span style=color:#ae81ff>hue</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>device</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>initial_press</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>subtype</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e>#Hue dimmer switch buttons, 1-4, top to bottom</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>light.turn_on</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>data_template</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>light.room</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>kelvin</span>: <span style=color:#e6db74>&#34;{{ state_attr(&#39;sensor.circadian_values&#39;, &#39;colortemp&#39;) | int }}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>brightness_pct</span>: <span style=color:#e6db74>&#39;{{ state_attr(&#39;&#39;switch.circadian_lighting_circadian_lighting&#39;&#39;, &#39;&#39;brightness&#39;&#39;) | int }}&#39;</span>
</span></span></code></pre></div><p>This automation is intended to run when you press the &ldquo;On&rdquo; button on a given Hue Dimmer switch. I&rsquo;ve tried to comment things as best I can inline in the YAML, but lets discuss a bit. First off, the alias and description lines can be customized to whatever you like for labeling purposes. Next up, things that actually need to be changed in order to use this automation successfully. First off, underneath the <code>trigger:</code> line, the <code>*DeviceID*</code> tag needs to be swapped out with an actual device ID as listed in Home Assistant. To determine this device ID, open up your Home Assistant web interface. Navigate to Settings&ndash;>Devices and Services&ndash;>Devices. Click on the switch you&rsquo;re looking to automate, and the DeviceID will a long string of characters at the end of that page&rsquo;s URL, as seen in the image below.</p><figure class=align-center>
<img loading=lazy src=DeviceID.png#center alt="Device ID can be found circled in red, in the URL bar"> <figcaption>
<p>Device ID can be found circled in red, in the URL bar</p></figcaption></figure><p>From there, you may want to change the <code>subtype:</code> line. This is where you choose which button on the Hue dimmer you are using to trigger the automation. They are numbered 1-4, top to bottom. You will probably want to leave this on 1, using the top switch to turn on the lights.</p><p>Only two more things that will need changing. The first is <code>entity_id</code>. The Hue Home Assistant integration creates an entity for every room with lights in it. To find the entity ID of a given room&rsquo;s lights, navigate to Settings&ndash;>Devices and Services&ndash;>Entities. Find the entity which corresponds to your room&rsquo;s lights, click on it, and the entity ID will be listed. It should be in the rough format I listed in the code above. Lastly, in the <code>brightness_pct:</code> line, you will see the <code>switch.circadian_lighting_circadian_lighting</code> string. This is the entity ID of the switch created by the Circadian Lighting custom integration. Pull up your list of entities again, and search for Circadian Lighting. You should see the switch there, and be able to verify its entity ID.</p><p>With those changes made, you should be good to go. All thats left now is to setup the automation for the off button now as well&ndash; see below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#75715e>#Turn Lights OFF when designated Hue Dimmer button is pressed</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>alias</span>: <span style=color:#ae81ff>HueCL - *Room* Switch - OFF</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>HueCL for *Room* Lights</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>single</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>trigger</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>device_id</span>: <span style=color:#75715e>*DeviceID*</span> <span style=color:#75715e>#(device_id can be found in the URL of a given device when pulled up in HA Web UI)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>domain</span>: <span style=color:#ae81ff>hue</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>device</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>initial_press</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>subtype</span>: <span style=color:#ae81ff>4</span> <span style=color:#75715e>#Hue dimmer switch buttons, 1-4, top to bottom</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>light.turn_off</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>data_template</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>light.room</span>
</span></span></code></pre></div><p>Make changes here the same way as those above, and you&rsquo;ve got a dimmer switch setup. Rinse and repeat for other Dimmer switches. But what if you have a switch without multiple buttons? For example, the Hue In-Wall switch, or the Lutron Aurora? These switches only have a single button which is used to toggle the lights on/off with each press. They can be used with a single automation that incorporates a bit of if/else logic for the toggle functions. See below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-YAML data-lang=YAML><span style=display:flex><span><span style=color:#75715e>#Automatically turn Lights ON to CL setting when Toggle button is pressed (if lights are currently off), or turn lights off (if they are currently on)</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>alias</span>: <span style=color:#ae81ff>HueCL - Room Toggle</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>trigger</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>device_id</span>: <span style=color:#75715e>*DeviceID*</span> <span style=color:#75715e>#(device_id can be found in the URL of a given device when pulled up in HA Web UI)</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>domain</span>: <span style=color:#ae81ff>hue</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>platform</span>: <span style=color:#ae81ff>device</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>type</span>: <span style=color:#ae81ff>initial_press</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>subtype</span>: <span style=color:#ae81ff>1</span> <span style=color:#75715e>#Toggle button (Only one button)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>single</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>action</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>choose</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>#Check if lights are off</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>conditions</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>state</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>light.room</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>state</span>: <span style=color:#e6db74>&#34;off&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>sequence</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>light.turn_on</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>data_template</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>light.room</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>kelvin</span>: <span style=color:#e6db74>&#34;{{ state_attr(&#39;sensor.circadian_values&#39;, &#39;colortemp&#39;) | int }}&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>brightness_pct</span>: <span style=color:#e6db74>&#39;{{ state_attr(&#39;&#39;switch.circadian_lighting_circadian_lighting&#39;&#39;, &#39;&#39;brightness&#39;&#39;) | int }}&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>#Check if lights are on</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>conditions</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>condition</span>: <span style=color:#ae81ff>state</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>light.room</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>state</span>: <span style=color:#e6db74>&#34;on&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>sequence</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>service</span>: <span style=color:#ae81ff>light.turn_off</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>data_template</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>entity_id</span>: <span style=color:#ae81ff>light.room</span>
</span></span></code></pre></div><p>Just like before, you&rsquo;ll need to setup DeviceID, entity_id, and circadian lighting switch entity ID. With those values swapped in, the automation should be functioning.</p><p>That about covers it! These automation have been key for me in eliminating lingering irritations with my smart lighting setup. Now I can use Circadian Lighting to fully realize what I&rsquo;ve been referring to as &ldquo;Smart Lightings Natural Purpose.&rdquo; And, whenever I use a light switch to turn my lights on, they immediately switch on the the &ldquo;correct&rdquo; value as determined by Circadian Lighting. No delay! I hope these automations prove useful to you, either for a full solution, or as a starting point to something more complex.</p><h2 id=future-changes>Future Changes<a hidden class=anchor aria-hidden=true href=#future-changes>#</a></h2><p>Earlier, I mentioned that latency is a downside to this approach. I wanted to take the time to document where this issue comes from. Consider the flow of data that has to happen for a light switch to turn on:</p><figure class=align-center>
<img loading=lazy src=CL_Flow.png#center alt="Quite the process to get through every time you turn on a light"> <figcaption>
<p>Quite the process to get through every time you turn on a light</p></figcaption></figure><p>If its not readily apparent- thats quite the communication chain required to turn on a light. I mentioned this earlier, but to again elaborate:</p><p>Using this automation, usually my lights turn on/off near immediately, but occasionally there is a bit of a delay&ndash; maybe up to a second or two. Irritating. It also sometimes fails outright, and I&rsquo;ll have to toggle the switch a second time. Lastly, if you toggle the switch back and forth quickly, it can get overloaded, and you&rsquo;ll have to wait a few seconds, then flip the switch again for changes to be made.</p><p>With that long communication chain in mind, lets consider the original solution Robert and I worked on together, which he still maintains. While irritating to actively maintain, this solution is lower latency, and more reliable. In the above image, you can see that, using my HA automation solution, when a light switch is toggled, the circadian lighting sensor is queried, and there are all these hoops that have to be jumped through just for the lights to turn on to a particular value. With the original solution, the circadian lighting sensor entity is constantly updating a Hue scene by communicating with the Hue Bridge via the Hue API. That way, all the light switch has to do is pull a scene value from the Bridge. No hoops. Just request, and response. Much more efficient.</p><p>The perfect solution would have the efficiency of Robert&rsquo;s fork solution, while achieving the goal of my automation solution and not touching Circadian Lighting&rsquo;s code. Is that possible? I think so, and its only through documenting everything in this post that I&rsquo;ve been able to clarify my thoughts on the matter.</p><p>I&rsquo;m envisioning configuring a Home Assistant automation which monitors the Circadian Lighting Sensor for changes. That would be the automation&rsquo;s &ldquo;trigger.&rdquo; Whenever it sees a change in the Circadian Lighting Sensor entity, it would update a scene on the Hue bridge, just like the original fork solution. The complicated part is the mechanism by which it updates this scene.</p><p>The automation should be able to communicate with the Hue Bridge directly over the Hue API through <a href=https://www.home-assistant.io/integrations/rest_command/>REST commands</a>. Otherwise, the automation could trigger a python script that does the same thing. From there, the switch itself would be configured via Hue to simply turn the light on to that scene when toggled. With that setup, we&rsquo;d have the efficiency of the fork solution, without touching Circadian Lightings code, just as desired.</p><p>If its that easy, why haven&rsquo;t I done it? Well, things are easy in theory. I&rsquo;m far from an expert on complex Home Assistant automations, let alone working with the Hue API via REST commands, etc. Its going to require some experimentation, and a lot of trial and error. One of these days I&rsquo;ll get around to it, and I&rsquo;ll certainly write about it when I do. Maybe even finally put in that pull request! But in the meantime, I hope either the fork solution or the automation solution I&rsquo;ve detailed here may be helpful to someone. Till next time!</p></div><footer class=post-footer>
<ul class=post-tags>
<li><a href=https://wallacelabs.tech/tags/phillips-hue/>Phillips Hue</a></li><li><a href=https://wallacelabs.tech/tags/home-assistant/>Home Assistant</a></li><li><a href=https://wallacelabs.tech/tags/circadian-lighting/>Circadian Lighting</a></li><li><a href=https://wallacelabs.tech/tags/scripting/>Scripting</a></li></ul><nav class=paginav>
<a class=next href=https://wallacelabs.tech/posts/operating-an-unraid-hosted-containerized-wireguard-vpn-server-on-a-vlan/>
<span class=title>Next Page »</span>
<br>
<span>Operating an Unraid-Hosted, Containerized Wireguard VPN Server on a VLAN</span>
</a>
</nav><div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Fulfilling Smart Lighting's Natural Purpose on twitter" href="https://twitter.com/intent/tweet/?text=Fulfilling%20Smart%20Lighting%27s%20Natural%20Purpose&url=https%3a%2f%2fwallacelabs.tech%2fposts%2ffulfilling-smart-lightings-natural-purpose%2f&hashtags=PhillipsHue%2cHomeAssistant%2cCircadianLighting%2cScripting"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Fulfilling Smart Lighting's Natural Purpose on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwallacelabs.tech%2fposts%2ffulfilling-smart-lightings-natural-purpose%2f&title=Fulfilling%20Smart%20Lighting%27s%20Natural%20Purpose&summary=Fulfilling%20Smart%20Lighting%27s%20Natural%20Purpose&source=https%3a%2f%2fwallacelabs.tech%2fposts%2ffulfilling-smart-lightings-natural-purpose%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Fulfilling Smart Lighting's Natural Purpose on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwallacelabs.tech%2fposts%2ffulfilling-smart-lightings-natural-purpose%2f&title=Fulfilling%20Smart%20Lighting%27s%20Natural%20Purpose"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Fulfilling Smart Lighting's Natural Purpose on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwallacelabs.tech%2fposts%2ffulfilling-smart-lightings-natural-purpose%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Fulfilling Smart Lighting's Natural Purpose on whatsapp" href="https://api.whatsapp.com/send?text=Fulfilling%20Smart%20Lighting%27s%20Natural%20Purpose%20-%20https%3a%2f%2fwallacelabs.tech%2fposts%2ffulfilling-smart-lightings-natural-purpose%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Fulfilling Smart Lighting's Natural Purpose on telegram" href="https://telegram.me/share/url?text=Fulfilling%20Smart%20Lighting%27s%20Natural%20Purpose&url=https%3a%2f%2fwallacelabs.tech%2fposts%2ffulfilling-smart-lightings-natural-purpose%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div></footer></article></main><footer class=footer>
<span>&copy; 2022 <a href=https://wallacelabs.tech>wallaceLabs</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script>
<script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script>
</body></html>